<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>SmallBiz BookKeeping Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #eef2ff;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* License Screen */
        .license-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .license-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .license-container {
            background: white;
            border-radius: 24px;
            padding: 56px;
            max-width: 520px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
        }

        .license-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .license-header h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
        }

        .license-form {
            margin-bottom: 32px;
        }

        .license-form h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .license-form input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
        }

        .license-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
            transform: translateY(-1px);
        }

        .license-message {
            margin-top: 16px;
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .license-message.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            display: block;
            border: 2px solid #10b981;
        }

        .license-message.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            display: block;
            border: 2px solid #ef4444;
        }

        .license-footer {
            text-align: center;
            padding-top: 28px;
            border-top: 2px solid var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
        }

        .license-footer p:first-child {
            color: var(--text-primary);
            font-size: 16px;
        }

        /* Main Application */
        .main-app {
            min-height: 100vh;
            display: none;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 20px 0;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .license-info {
            font-size: 13px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        /* Navigation */
        .main-nav {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            display: flex;
            gap: 4px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }

        .nav-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .nav-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--primary-light);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 32px 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Buttons */
        .btn-primary, .btn-secondary, .btn-danger {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-secondary);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }

        .chart-container {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        /* Transactions */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .section-header h2 {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--text-primary);
        }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters input,
        .filters select {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .filters input:focus,
        .filters select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .filters input {
            flex: 1;
            min-width: 200px;
        }

        .bulk-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .transactions-list {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
            overflow: hidden;
        }

        .transaction-header {
            display: grid;
            grid-template-columns: 40px 110px 90px 140px 2fr 130px 140px;
            gap: 20px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
            font-size: 13px;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transaction-item {
            display: grid;
            grid-template-columns: 40px 110px 90px 140px 2fr 130px 140px;
            gap: 20px;
            padding: 20px;
            border-bottom: 1px solid var(--bg-tertiary);
            align-items: center;
            transition: all 0.2s ease;
        }

        .transaction-item:hover {
            background: var(--bg-secondary);
            transform: translateX(2px);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-date {
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .transaction-category {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .transaction-description {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .transaction-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .transaction-type {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.3px;
        }

        .transaction-type.income {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #10b981;
        }

        .transaction-type.expense {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .transaction-amount {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
        }

        .transaction-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* Reports */
        .report-controls {
            background: white;
            padding: 28px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .report-controls label {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .report-controls input {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
        }

        .report-controls input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
        }

        .report-card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .report-card h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .report-card .export-pdf {
            margin-top: 20px;
            width: 100%;
        }

        /* Tax Center */
        .tax-controls {
            background: white;
            padding: 28px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            align-items: flex-end;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .tax-controls label {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .tax-controls select {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
        }

        .tax-controls select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .tax-summary {
            background: white;
            padding: 28px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .tax-actions {
            display: flex;
            gap: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 540px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 28px;
            border-bottom: 2px solid var(--bg-tertiary);
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .close {
            font-size: 32px;
            font-weight: 300;
            color: var(--text-muted);
            cursor: pointer;
            line-height: 1;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .close:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .modal-content form {
            padding: 28px;
        }

        .modal-content label {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.3s ease;
        }

        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .modal-content textarea {
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .modal-actions button {
            flex: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            
            .main-nav {
                overflow-x: auto;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .transaction-header {
                display: none;
            }
            
            .transaction-item {
                grid-template-columns: 40px 1fr 100px;
                gap: 12px;
            }
            
            .transaction-item .transaction-category,
            .transaction-item .transaction-description {
                display: none;
            }
            
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .license-container {
                padding: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- License Activation Screen -->
    <div id="licenseScreen" class="license-screen">
        <div class="license-container">
            <div class="license-header">
                <h1>SmallBiz BookKeeping Pro</h1>
                <p class="tagline">Professional Accounting for Small Businesses</p>
            </div>
            <div class="license-form">
                <h2>Activate Your License</h2>
                <input type="text" id="licenseKeyInput" placeholder="XXXX-XXXX-XXXX-XXXX" maxlength="19">
                <button id="activateBtn" class="btn-primary">Activate License</button>
                <p class="license-message" id="licenseMessage"></p>
            </div>
            <div class="license-footer">
                <p>Single License Purchase: $250</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1>SmallBiz BookKeeping Pro</h1>
                <div class="header-actions">
                    <span class="license-info" id="licenseInfo"></span>
                    <button id="logoutBtn" class="btn-secondary">Logout</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="main-nav">
            <button class="nav-btn active" data-tab="dashboard">Dashboard</button>
            <button class="nav-btn" data-tab="transactions">Transactions</button>
            <button class="nav-btn" data-tab="reports">Reports</button>
            <button class="nav-btn" data-tab="tax">Tax Center</button>
            <button class="nav-btn" data-tab="settings">Settings</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Tab -->
            <section id="dashboardTab" class="tab-content active">
                <h2>Dashboard Overview</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <p class="stat-value" id="totalRevenue">$0.00</p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Expenses</h3>
                        <p class="stat-value" id="totalExpenses">$0.00</p>
                    </div>
                    <div class="stat-card">
                        <h3>Net Income</h3>
                        <p class="stat-value" id="netIncome">$0.00</p>
                    </div>
                    <div class="stat-card">
                        <h3>Transactions</h3>
                        <p class="stat-value" id="totalTransactions">0</p>
                    </div>
                </div>
                <div class="chart-container" style="max-width: 600px; margin: 0 auto;">
                    <h3>Income vs Expenses Overview</h3>
                    <div style="max-height: 350px; position: relative;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Transactions Tab -->
            <section id="transactionsTab" class="tab-content">
                <div class="section-header">
                    <h2>Transactions</h2>
                    <button id="addTransactionBtn" class="btn-primary">Add Transaction</button>
                </div>
                
                <div class="filters">
                    <input type="text" id="searchTransaction" placeholder="Search transactions...">
                    <select id="filterType">
                        <option value="all">All Types</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                    <select id="filterCategory">
                        <option value="all">All Categories</option>
                    </select>
                </div>

                <div class="bulk-actions">
                    <button id="selectAllBtn" class="btn-secondary">Select All</button>
                    <button id="deleteSelectedBtn" class="btn-danger">Delete Selected</button>
                    <button id="exportSelectedBtn" class="btn-secondary">Export Selected</button>
                    <button id="importBtn" class="btn-primary">Import CSV/Excel</button>
                    <button id="downloadTemplateBtn" class="btn-secondary">Download Template</button>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>

                <div class="transactions-list" id="transactionsList">
                    <!-- Header and transactions will be rendered here -->
                </div>
            </section>

            <!-- Reports Tab -->
            <section id="reportsTab" class="tab-content">
                <h2>Financial Reports</h2>
                <div class="report-controls">
                    <label>
                        Start Date:
                        <input type="date" id="reportStartDate">
                    </label>
                    <label>
                        End Date:
                        <input type="date" id="reportEndDate">
                    </label>
                    <button id="generateReportBtn" class="btn-primary">Generate Reports</button>
                </div>

                <div class="reports-grid">
                    <div class="report-card">
                        <h3>Income Statement</h3>
                        <div id="incomeStatement"></div>
                        <button class="btn-secondary export-pdf" data-report="income">Export PDF</button>
                    </div>
                    <div class="report-card">
                        <h3>Cash Flow</h3>
                        <div id="cashFlow"></div>
                        <button class="btn-secondary export-pdf" data-report="cashflow">Export PDF</button>
                    </div>
                    <div class="report-card">
                        <h3>Category Analysis</h3>
                        <div id="categoryAnalysis"></div>
                        <button class="btn-secondary export-pdf" data-report="category">Export PDF</button>
                    </div>
                </div>
            </section>

            <!-- Tax Center Tab -->
            <section id="taxTab" class="tab-content">
                <h2>Tax Center - Schedule C</h2>
                <div class="tax-controls">
                    <label>
                        Tax Year:
                        <select id="taxYear">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </label>
                    <button id="generateTaxBtn" class="btn-primary">Generate Tax Summary</button>
                </div>

                <div class="tax-summary" id="taxSummary">
                    <!-- Tax summary will be rendered here -->
                </div>

                <div class="tax-actions">
                    <button id="exportTaxPdfBtn" class="btn-primary">Export Tax PDF</button>
                    <button id="exportTaxExcelBtn" class="btn-secondary">Export to Excel</button>
                </div>
            </section>

            <!-- Settings Tab -->
            <section id="settingsTab" class="tab-content">
                <h2>Business Settings</h2>
                
                <div class="report-card" style="max-width: 800px; margin: 0 auto;">
                    <h3>Business/Individual Information</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">This information will appear on reports and tax documents.</p>
                    
                    <form id="settingsForm">
                        <label>
                            Currency:
                            <select id="settingsCurrency">
                                <option value="USD">üá∫üá∏ US Dollar (USD) - $</option>
                                <option value="EUR">üá™üá∫ Euro (EUR) - ‚Ç¨</option>
                                <option value="GBP">üá¨üáß British Pound (GBP) - ¬£</option>
                                <option value="CAD">üá®üá¶ Canadian Dollar (CAD) - $</option>
                                <option value="AUD">üá¶üá∫ Australian Dollar (AUD) - $</option>
                                <option value="JPY">üáØüáµ Japanese Yen (JPY) - ¬•</option>
                                <option value="CNY">üá®üá≥ Chinese Yuan (CNY) - ¬•</option>
                                <option value="INR">üáÆüá≥ Indian Rupee (INR) - ‚Çπ</option>
                                <option value="MXN">üá≤üáΩ Mexican Peso (MXN) - $</option>
                                <option value="BRL">üáßüá∑ Brazilian Real (BRL) - R$</option>
                                <option value="ZAR">üáøüá¶ South African Rand (ZAR) - R</option>
                                <option value="NGN">üá≥üá¨ Nigerian Naira (NGN) - ‚Ç¶</option>
                                <option value="GHS">üá¨üá≠ Ghanaian Cedi (GHS) - ‚Çµ</option>
                                <option value="KES">üá∞üá™ Kenyan Shilling (KES) - KSh</option>
                                <option value="CHF">üá®üá≠ Swiss Franc (CHF) - Fr</option>
                                <option value="SEK">üá∏üá™ Swedish Krona (SEK) - kr</option>
                                <option value="NOK">üá≥üá¥ Norwegian Krone (NOK) - kr</option>
                                <option value="DKK">üá©üá∞ Danish Krone (DKK) - kr</option>
                                <option value="PLN">üáµüá± Polish Zloty (PLN) - z≈Ç</option>
                                <option value="SGD">üá∏üá¨ Singapore Dollar (SGD) - $</option>
                                <option value="HKD">üá≠üá∞ Hong Kong Dollar (HKD) - $</option>
                                <option value="NZD">üá≥üáø New Zealand Dollar (NZD) - $</option>
                                <option value="KRW">üá∞üá∑ South Korean Won (KRW) - ‚Ç©</option>
                                <option value="THB">üáπüá≠ Thai Baht (THB) - ‡∏ø</option>
                                <option value="MYR">üá≤üáæ Malaysian Ringgit (MYR) - RM</option>
                                <option value="PHP">üáµüá≠ Philippine Peso (PHP) - ‚Ç±</option>
                                <option value="IDR">üáÆüá© Indonesian Rupiah (IDR) - Rp</option>
                                <option value="AED">üá¶üá™ UAE Dirham (AED) - ÿØ.ÿ•</option>
                                <option value="SAR">üá∏üá¶ Saudi Riyal (SAR) - Ô∑º</option>
                            </select>
                        </label>
                        
                        <label>
                            Business/Individual Name:
                            <input type="text" id="settingsBusinessName" placeholder="e.g., John Doe or Acme Consulting LLC">
                        </label>
                        
                        <label>
                            Street Address:
                            <input type="text" id="settingsAddress" placeholder="e.g., 123 Main Street">
                        </label>
                        
                        <label style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                City:
                                <input type="text" id="settingsCity" placeholder="e.g., New York">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                State:
                                <input type="text" id="settingsState" placeholder="e.g., NY" maxlength="2">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ZIP:
                                <input type="text" id="settingsZip" placeholder="e.g., 10001" maxlength="10">
                            </div>
                        </label>
                        
                        <label>
                            Phone Number (Optional):
                            <input type="tel" id="settingsPhone" placeholder="e.g., (555) 123-4567">
                        </label>
                        
                        <label>
                            Email (Optional):
                            <input type="email" id="settingsEmail" placeholder="e.g., john@example.com">
                        </label>
                        
                        <label>
                            Tax ID / EIN / SSN (Optional):
                            <input type="text" id="settingsTaxId" placeholder="e.g., 12-3456789">
                        </label>
                        
                        <div style="margin-top: 28px; display: flex; gap: 12px;">
                            <button type="submit" class="btn-primary">Save Settings</button>
                            <button type="button" id="clearSettingsBtn" class="btn-secondary">Clear All</button>
                        </div>
                    </form>
                    
                    <div id="settingsSavedMessage" style="display: none; margin-top: 20px; padding: 14px 18px; border-radius: 12px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; border: 2px solid #10b981; font-weight: 500;">
                        ‚úÖ Settings saved successfully!
                    </div>
                    
                    <div id="dataStatusInfo" style="margin-top: 20px; padding: 14px 18px; border-radius: 12px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 2px solid #e2e8f0; font-size: 13px; line-height: 1.6;">
                        <strong>üìä Data Status:</strong><br>
                        <span id="dataStatusText">Loading...</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Transaction</h2>
                <span class="close">&times;</span>
            </div>
            <form id="transactionForm">
                <label>
                    Date:
                    <input type="date" id="txDate" required>
                </label>
                <label>
                    Type:
                    <select id="txType" required>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </label>
                <label>
                    Category:
                    <select id="txCategory" required>
                        <!-- Categories will be populated dynamically -->
                    </select>
                </label>
                <label>
                    Description:
                    <input type="text" id="txDescription" required>
                </label>
                <label>
                    Amount:
                    <input type="number" id="txAmount" step="0.01" min="0" required>
                </label>
                <label>
                    Notes:
                    <textarea id="txNotes" rows="3"></textarea>
                </label>
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Save Transaction</button>
                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // ============================================
        // ALGORITHM-BASED LICENSE AUTHENTICATION
        // ============================================
        
        class LicenseAuth {
            constructor() {
                this.licenseKey = null;
                this.deviceFingerprint = null;
                // Secret seed for validation (keep this private when moving to backend)
                this.SECRET_SEED = 'SBKP-2025-PRO-v1.0';
            }

            // Calculate checksum for a license key
            calculateChecksum(key) {
                const parts = key.split('-');
                if (parts.length !== 4) return null;
                
                let sum = 0;
                const segment = parts[0] + parts[1] + parts[2];
                
                for (let i = 0; i < segment.length; i++) {
                    const char = segment[i];
                    const value = char.charCodeAt(0);
                    sum += value * (i + 1);
                }
                
                // Add secret seed influence
                for (let i = 0; i < this.SECRET_SEED.length; i++) {
                    sum += this.SECRET_SEED.charCodeAt(i);
                }
                
                return sum;
            }

            // Validate license key format and checksum
            validateLicenseKey(key) {
                // Format check: XXXX-XXXX-XXXX-XXXX
                const pattern = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
                if (!pattern.test(key)) {
                    return { valid: false, error: 'Invalid license key format' };
                }
                
                const parts = key.split('-');
                const checksum = this.calculateChecksum(key);
                
                // Validate checksum matches pattern
                // Last segment should match a derived pattern from first 3 segments
                const expectedPattern = this.derivePattern(parts[0], parts[1], parts[2]);
                
                if (this.matchesPattern(parts[3], expectedPattern, checksum)) {
                    return { valid: true };
                }
                
                return { valid: false, error: 'Invalid license key' };
            }

            // Derive expected pattern from first 3 segments
            derivePattern(seg1, seg2, seg3) {
                let pattern = '';
                const combined = seg1 + seg2 + seg3;
                
                for (let i = 0; i < 4; i++) {
                    const index = (i * 3) % combined.length;
                    pattern += combined[index];
                }
                
                return pattern;
            }

            // Check if segment matches the expected pattern
            matchesPattern(segment, expectedPattern, checksum) {
                // Simple validation: segment should have relationship to pattern and checksum
                let score = 0;
                
                for (let i = 0; i < 4; i++) {
                    const charCode = segment.charCodeAt(i);
                    const patternCode = expectedPattern.charCodeAt(i);
                    const diff = Math.abs(charCode - patternCode);
                    
                    if (diff < 15) score++;
                }
                
                // At least 2 characters should be close to pattern
                return score >= 2;
            }

            async generateDeviceFingerprint() {
                const components = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    languages: navigator.languages ? navigator.languages.join(',') : '',
                    platform: navigator.platform,
                    screenResolution: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneOffset: new Date().getTimezoneOffset(),
                    hardwareConcurrency: navigator.hardwareConcurrency || 0,
                    deviceMemory: navigator.deviceMemory || 0,
                    canvasFingerprint: await this.getCanvasFingerprint(),
                    webglFingerprint: this.getWebGLFingerprint()
                };

                const fingerprint = JSON.stringify(components);
                return this.hashString(fingerprint);
            }

            async getCanvasFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = 200;
                    canvas.height = 50;
                    
                    ctx.textBaseline = 'top';
                    ctx.font = '14px "Arial"';
                    ctx.textBaseline = 'alphabetic';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = '#069';
                    ctx.fillText('SmallBiz BookKeeping Pro üîê', 2, 15);
                    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                    ctx.fillText('SmallBiz BookKeeping Pro üîê', 4, 17);

                    const dataURL = canvas.toDataURL();
                    return this.hashString(dataURL);
                } catch (e) {
                    return 'canvas-unavailable';
                }
            }

            getWebGLFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    
                    if (!gl) return 'webgl-unavailable';

                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';
                    const vendor = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown';

                    return this.hashString(`${renderer}-${vendor}`);
                } catch (e) {
                    return 'webgl-unavailable';
                }
            }

            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }

            async activateLicense(licenseKey) {
                console.log('üîë Validating license key:', licenseKey);
                
                const validation = this.validateLicenseKey(licenseKey);
                
                if (!validation.valid) {
                    return {
                        success: false,
                        error: validation.error
                    };
                }

                // Check if already activated on another device
                const deviceFP = await this.generateDeviceFingerprint();
                const storedFP = localStorage.getItem(`sbkp_fp_${licenseKey}`);
                
                if (storedFP && storedFP !== deviceFP) {
                    return {
                        success: false,
                        error: 'This license is already activated on another device'
                    };
                }

                // Store device fingerprint for this license
                localStorage.setItem(`sbkp_fp_${licenseKey}`, deviceFP);
                
                this.licenseKey = licenseKey;
                this.deviceFingerprint = deviceFP;
                
                this.saveLicenseData();

                return {
                    success: true,
                    licenseType: 'SINGLE',
                    features: ['all']
                };
            }

            async verifyLicense() {
                const savedLicense = localStorage.getItem('sbkp_license');
                const savedFingerprint = localStorage.getItem('sbkp_fingerprint');

                if (!savedLicense || !savedFingerprint) {
                    return false;
                }

                // Validate the license key format
                const validation = this.validateLicenseKey(savedLicense);
                if (!validation.valid) {
                    return false;
                }

                // Verify device fingerprint matches
                const currentFingerprint = await this.generateDeviceFingerprint();
                const storedFP = localStorage.getItem(`sbkp_fp_${savedLicense}`);

                if (!storedFP || savedFingerprint !== currentFingerprint) {
                    return false;
                }

                this.licenseKey = savedLicense;
                this.deviceFingerprint = savedFingerprint;
                return true;
            }

            deactivateLicense() {
                if (this.licenseKey) {
                    localStorage.removeItem(`sbkp_fp_${this.licenseKey}`);
                }
                
                localStorage.removeItem('sbkp_license');
                localStorage.removeItem('sbkp_fingerprint');
                
                this.licenseKey = null;
                this.deviceFingerprint = null;
            }

            saveLicenseData() {
                localStorage.setItem('sbkp_license', this.licenseKey);
                localStorage.setItem('sbkp_fingerprint', this.deviceFingerprint);
            }

            getLicenseInfo() {
                if (!this.licenseKey) return null;

                return {
                    key: this.licenseKey,
                    type: 'SINGLE',
                    features: ['all'],
                    activatedAt: new Date().toISOString()
                };
            }

            // License key generator (for your use when creating new licenses)
            static generateLicenseKey() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed confusing chars: 0, O, I, 1
                const segments = [];
                
                for (let i = 0; i < 4; i++) {
                    let segment = '';
                    for (let j = 0; j < 4; j++) {
                        segment += chars[Math.floor(Math.random() * chars.length)];
                    }
                    segments.push(segment);
                }
                
                return segments.join('-');
            }
        }

        // ============================================
        // APPLICATION CODE
        // ============================================
        
        // Helper function to format currency with commas
        function formatCurrency(amount) {
            const currency = APP.businessSettings.currency || 'USD';
            
            // Currency locale mapping for proper formatting
            const localeMap = {
                'USD': 'en-US', 'EUR': 'de-DE', 'GBP': 'en-GB', 'CAD': 'en-CA',
                'AUD': 'en-AU', 'JPY': 'ja-JP', 'CNY': 'zh-CN', 'INR': 'en-IN',
                'MXN': 'es-MX', 'BRL': 'pt-BR', 'ZAR': 'en-ZA', 'NGN': 'en-NG',
                'GHS': 'en-GH', 'KES': 'en-KE', 'CHF': 'de-CH', 'SEK': 'sv-SE',
                'NOK': 'nb-NO', 'DKK': 'da-DK', 'PLN': 'pl-PL', 'SGD': 'en-SG',
                'HKD': 'zh-HK', 'NZD': 'en-NZ', 'KRW': 'ko-KR', 'THB': 'th-TH',
                'MYR': 'ms-MY', 'PHP': 'en-PH', 'IDR': 'id-ID', 'AED': 'ar-AE',
                'SAR': 'ar-SA'
            };
            
            const locale = localeMap[currency] || 'en-US';
            
            return parseFloat(amount).toLocaleString(locale, {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Application State
        const APP = {
            version: '1.0.0',
            licenseKey: null,
            transactions: [],
            businessSettings: {
                currency: 'USD',
                businessName: '',
                address: '',
                city: '',
                state: '',
                zip: '',
                phone: '',
                email: '',
                taxId: ''
            },
            categories: {
                income: ['Sales', 'Services', 'Consulting', 'Products', 'Other Income'],
                expense: ['Advertising', 'Car & Truck', 'Commissions', 'Contract Labor', 'Depreciation', 
                          'Employee Benefits', 'Insurance', 'Legal & Professional', 'Office Expense', 
                          'Rent', 'Repairs & Maintenance', 'Supplies', 'Travel', 'Meals', 'Utilities', 
                          'Wages', 'Other Expenses']
            },
            chart: null,
            editingTransactionId: null
        };

        // Initialize Advanced License System
        const licenseAuth = new LicenseAuth();

        // License Management Functions
        async function activateLicense(licenseKey) {
            console.log('üîë Attempting to activate license:', licenseKey);
            const messageEl = document.getElementById('licenseMessage');
            
            try {
                const result = await licenseAuth.activateLicense(licenseKey);
                console.log('üìã Activation result:', result);
                
                if (result.success) {
                    messageEl.textContent = 'License activated successfully!';
                    messageEl.className = 'license-message success';
                    
                    APP.licenseKey = licenseKey;
                    
                    setTimeout(() => {
                        showMainApp();
                    }, 1000);
                } else {
                    messageEl.textContent = result.error;
                    messageEl.className = 'license-message error';
                }
            } catch (error) {
                console.error('‚ùå License activation error:', error);
                messageEl.textContent = 'Error: ' + error.message;
                messageEl.className = 'license-message error';
            }
        }

        async function checkLicense() {
            const isValid = await licenseAuth.verifyLicense();
            if (isValid) {
                APP.licenseKey = licenseAuth.licenseKey;
            }
            return isValid;
        }

        function logout() {
            if (confirm('Are you sure you want to logout?\n\nYour data will be saved and available when you login again with this license.\n\nNote: Data is automatically deleted after 30 days of inactivity.')) {
                licenseAuth.deactivateLicense();
                location.reload();
            }
        }

        function showMainApp() {
            document.getElementById('licenseScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('licenseInfo').textContent = `License: ${APP.licenseKey}`;
            loadData();
            initializeApp();
        }

        // Data Management
        function saveData() {
            if (!APP.licenseKey) return;
            
            const dataPackage = {
                transactions: APP.transactions,
                settings: APP.businessSettings,
                lastSaved: new Date().toISOString()
            };
            
            // Store with license key prefix for isolation
            localStorage.setItem(`sbkp_data_${APP.licenseKey}`, JSON.stringify(dataPackage));
            
            // Clean up old data from other licenses (older than 30 days)
            cleanupOldData();
        }

        function loadData() {
            if (!APP.licenseKey) return;
            
            const savedData = localStorage.getItem(`sbkp_data_${APP.licenseKey}`);
            if (savedData) {
                try {
                    const dataPackage = JSON.parse(savedData);
                    
                    // Check if data is older than 30 days
                    const lastSaved = new Date(dataPackage.lastSaved);
                    const daysSinceLastSave = (new Date() - lastSaved) / (1000 * 60 * 60 * 24);
                    
                    if (daysSinceLastSave > 30) {
                        console.log('‚è∞ Data is older than 30 days, clearing...');
                        localStorage.removeItem(`sbkp_data_${APP.licenseKey}`);
                        alert('Your data was inactive for over 30 days and has been cleared for security.');
                        return;
                    }
                    
                    // Load the data
                    APP.transactions = dataPackage.transactions || [];
                    APP.businessSettings = dataPackage.settings || {
                        currency: 'USD',
                        businessName: '',
                        address: '',
                        city: '',
                        state: '',
                        zip: '',
                        phone: '',
                        email: '',
                        taxId: ''
                    };
                    loadSettingsToForm();
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }
        }
        
        function cleanupOldData() {
            // Find all license data keys in localStorage
            const allKeys = Object.keys(localStorage);
            const dataKeys = allKeys.filter(key => key.startsWith('sbkp_data_'));
            
            dataKeys.forEach(key => {
                // Skip current license
                if (key === `sbkp_data_${APP.licenseKey}`) return;
                
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data && data.lastSaved) {
                        const lastSaved = new Date(data.lastSaved);
                        const daysSinceLastSave = (new Date() - lastSaved) / (1000 * 60 * 60 * 24);
                        
                        // Delete if older than 30 days
                        if (daysSinceLastSave > 30) {
                            console.log(`üóëÔ∏è Removing old data for ${key} (${Math.floor(daysSinceLastSave)} days old)`);
                            localStorage.removeItem(key);
                        }
                    }
                } catch (error) {
                    // Invalid data, remove it
                    localStorage.removeItem(key);
                }
            });
        }
        
        function loadSettingsToForm() {
            document.getElementById('settingsCurrency').value = APP.businessSettings.currency || 'USD';
            document.getElementById('settingsBusinessName').value = APP.businessSettings.businessName || '';
            document.getElementById('settingsAddress').value = APP.businessSettings.address || '';
            document.getElementById('settingsCity').value = APP.businessSettings.city || '';
            document.getElementById('settingsState').value = APP.businessSettings.state || '';
            document.getElementById('settingsZip').value = APP.businessSettings.zip || '';
            document.getElementById('settingsPhone').value = APP.businessSettings.phone || '';
            document.getElementById('settingsEmail').value = APP.businessSettings.email || '';
            document.getElementById('settingsTaxId').value = APP.businessSettings.taxId || '';
        }
        
        function saveSettings() {
            APP.businessSettings = {
                currency: document.getElementById('settingsCurrency').value,
                businessName: document.getElementById('settingsBusinessName').value,
                address: document.getElementById('settingsAddress').value,
                city: document.getElementById('settingsCity').value,
                state: document.getElementById('settingsState').value.toUpperCase(),
                zip: document.getElementById('settingsZip').value,
                phone: document.getElementById('settingsPhone').value,
                email: document.getElementById('settingsEmail').value,
                taxId: document.getElementById('settingsTaxId').value
            };
            
            saveData();
            
            // Refresh dashboard to show new currency
            updateDashboard();
            renderTransactions();
            
            // Show success message
            const messageEl = document.getElementById('settingsSavedMessage');
            messageEl.style.display = 'block';
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }
        
        function clearSettings() {
            if (confirm('Are you sure you want to clear all business settings?')) {
                APP.businessSettings = {
                    currency: 'USD',
                    businessName: '',
                    address: '',
                    city: '',
                    state: '',
                    zip: '',
                    phone: '',
                    email: '',
                    taxId: ''
                };
                loadSettingsToForm();
                saveData();
                updateDashboard();
                renderTransactions();
            }
        }
        
        function updateDataStatus() {
            const statusEl = document.getElementById('dataStatusText');
            if (!statusEl || !APP.licenseKey) return;
            
            const savedData = localStorage.getItem(`sbkp_data_${APP.licenseKey}`);
            if (!savedData) {
                statusEl.innerHTML = 'No saved data yet. Start adding transactions!';
                return;
            }
            
            try {
                const dataPackage = JSON.parse(savedData);
                const lastSaved = new Date(dataPackage.lastSaved);
                const daysSinceLastSave = (new Date() - lastSaved) / (1000 * 60 * 60 * 24);
                const daysRemaining = Math.max(0, 30 - Math.floor(daysSinceLastSave));
                
                const transactionCount = dataPackage.transactions?.length || 0;
                
                let statusHTML = `
                    Last saved: <strong>${lastSaved.toLocaleDateString()} at ${lastSaved.toLocaleTimeString()}</strong><br>
                    Transactions stored: <strong>${transactionCount}</strong><br>
                    Data expires in: <strong>${daysRemaining} days</strong>
                `;
                
                if (daysRemaining < 7) {
                    statusHTML += `<br><span style="color: #dc2626;">‚ö†Ô∏è Warning: Data will be auto-deleted in ${daysRemaining} days! Login to refresh.</span>`;
                } else if (daysRemaining < 14) {
                    statusHTML += `<br><span style="color: #f59e0b;">‚è∞ Reminder: Data expires in ${daysRemaining} days.</span>`;
                }
                
                statusEl.innerHTML = statusHTML;
            } catch (error) {
                statusEl.innerHTML = 'Unable to load data status.';
            }
        }
        
        function getBusinessHeader() {
            const s = APP.businessSettings;
            if (!s.businessName && !s.address) {
                return '';
            }
            
            let header = '';
            if (s.businessName) header += s.businessName + '\n';
            if (s.address) header += s.address + '\n';
            if (s.city || s.state || s.zip) {
                header += (s.city ? s.city + ', ' : '') + 
                         (s.state ? s.state + ' ' : '') + 
                         (s.zip || '') + '\n';
            }
            if (s.phone) header += 'Phone: ' + s.phone + '\n';
            if (s.email) header += 'Email: ' + s.email + '\n';
            if (s.taxId) header += 'Tax ID: ' + s.taxId + '\n';
            
            return header;
        }

        // Transaction Management
        function addTransaction(transaction) {
            transaction.id = Date.now().toString();
            APP.transactions.push(transaction);
            saveData();
            renderTransactions();
            updateDashboard();
        }

        function updateTransaction(id, transaction) {
            const index = APP.transactions.findIndex(t => t.id === id);
            if (index !== -1) {
                transaction.id = id;
                APP.transactions[index] = transaction;
                saveData();
                renderTransactions();
                updateDashboard();
            }
        }

        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                APP.transactions = APP.transactions.filter(t => t.id !== id);
                saveData();
                renderTransactions();
                updateDashboard();
            }
        }

        function deleteSelectedTransactions() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select transactions to delete');
                return;
            }
            
            if (confirm(`Delete ${checkboxes.length} selected transaction(s)?`)) {
                checkboxes.forEach(cb => {
                    APP.transactions = APP.transactions.filter(t => t.id !== cb.dataset.id);
                });
                saveData();
                renderTransactions();
                updateDashboard();
            }
        }

        // Rendering
        function renderTransactions() {
            const container = document.getElementById('transactionsList');
            const searchTerm = document.getElementById('searchTransaction').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            
            let filtered = APP.transactions.filter(t => {
                const matchesSearch = t.description.toLowerCase().includes(searchTerm) || 
                                    (t.notes && t.notes.toLowerCase().includes(searchTerm));
                const matchesType = typeFilter === 'all' || t.type === typeFilter;
                const matchesCategory = categoryFilter === 'all' || t.category === categoryFilter;
                return matchesSearch && matchesType && matchesCategory;
            });
            
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const header = `
                <div class="transaction-header">
                    <div></div>
                    <div>Date</div>
                    <div>Type</div>
                    <div>Category</div>
                    <div>Description</div>
                    <div>Amount</div>
                    <div>Actions</div>
                </div>
            `;
            
            if (filtered.length === 0) {
                container.innerHTML = header + '<div style="padding: 32px; text-align: center; color: var(--text-secondary);">No transactions found</div>';
                return;
            }
            
            const rows = filtered.map(t => `
                <div class="transaction-item">
                    <input type="checkbox" class="transaction-checkbox" data-id="${t.id}">
                    <div class="transaction-date">${new Date(t.date).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })}</div>
                    <div class="transaction-type ${t.type}">${t.type}</div>
                    <div class="transaction-category">${t.category}</div>
                    <div class="transaction-description">${t.description}</div>
                    <div class="transaction-amount">${formatCurrency(t.amount)}</div>
                    <div class="transaction-actions">
                        <button class="action-btn" onclick="editTransaction('${t.id}')">Edit</button>
                        <button class="action-btn" onclick="deleteTransaction('${t.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = header + rows;
        }

        function updateDashboard() {
            const income = APP.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const expenses = APP.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            document.getElementById('totalRevenue').textContent = formatCurrency(income);
            document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
            document.getElementById('netIncome').textContent = formatCurrency(income - expenses);
            document.getElementById('totalTransactions').textContent = APP.transactions.length;
            
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;
            
            // Calculate total income and expenses across all transactions
            const totalIncome = APP.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const totalExpenses = APP.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            if (APP.chart) {
                APP.chart.destroy();
            }
            
            APP.chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Income', 'Expenses'],
                    datasets: [{
                        data: [totalIncome, totalExpenses],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(16, 185, 129, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: $${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Modal Management
        function showTransactionModal(transactionId = null) {
            const modal = document.getElementById('transactionModal');
            const form = document.getElementById('transactionForm');
            
            APP.editingTransactionId = transactionId;
            
            if (transactionId) {
                const transaction = APP.transactions.find(t => t.id === transactionId);
                document.getElementById('modalTitle').textContent = 'Edit Transaction';
                document.getElementById('txDate').value = transaction.date;
                document.getElementById('txType').value = transaction.type;
                updateCategoryOptions(transaction.type);
                document.getElementById('txCategory').value = transaction.category;
                document.getElementById('txDescription').value = transaction.description;
                document.getElementById('txAmount').value = transaction.amount;
                document.getElementById('txNotes').value = transaction.notes || '';
            } else {
                document.getElementById('modalTitle').textContent = 'Add Transaction';
                form.reset();
                document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
                updateCategoryOptions('income');
            }
            
            modal.classList.add('show');
        }

        function hideTransactionModal() {
            document.getElementById('transactionModal').classList.remove('show');
            APP.editingTransactionId = null;
        }

        function updateCategoryOptions(type) {
            const categorySelect = document.getElementById('txCategory');
            const categories = APP.categories[type] || [];
            categorySelect.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function editTransaction(id) {
            showTransactionModal(id);
        }

        // Reports
        function generateReports() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const filtered = APP.transactions.filter(t => {
                return t.date >= startDate && t.date <= endDate;
            });
            
            generateIncomeStatement(filtered, startDate, endDate);
            generateCashFlow(filtered, startDate, endDate);
            generateCategoryAnalysis(filtered, startDate, endDate);
        }

        function generateIncomeStatement(transactions, startDate, endDate) {
            const income = transactions.filter(t => t.type === 'income');
            const expenses = transactions.filter(t => t.type === 'expense');
            
            const totalIncome = income.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const netIncome = totalIncome - totalExpenses;
            
            const html = `
                <div style="font-family: 'Roboto Mono', monospace; font-size: 14px;">
                    <p><strong>Period:</strong> ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}</p>
                    <hr style="margin: 16px 0;">
                    <p><strong>Total Income:</strong> ${formatCurrency(totalIncome)}</p>
                    <p><strong>Total Expenses:</strong> ${formatCurrency(totalExpenses)}</p>
                    <hr style="margin: 16px 0;">
                    <p style="font-size: 16px;"><strong>Net Income:</strong> ${formatCurrency(netIncome)}</p>
                </div>
            `;
            
            document.getElementById('incomeStatement').innerHTML = html;
        }

        function generateCashFlow(transactions, startDate, endDate) {
            const income = transactions.filter(t => t.type === 'income');
            const expenses = transactions.filter(t => t.type === 'expense');
            
            const cashIn = income.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const cashOut = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const netCash = cashIn - cashOut;
            
            const html = `
                <div style="font-family: 'Roboto Mono', monospace; font-size: 14px;">
                    <p><strong>Period:</strong> ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}</p>
                    <hr style="margin: 16px 0;">
                    <p><strong>Cash In:</strong> ${formatCurrency(cashIn)}</p>
                    <p><strong>Cash Out:</strong> ${formatCurrency(cashOut)}</p>
                    <hr style="margin: 16px 0;">
                    <p style="font-size: 16px;"><strong>Net Cash Flow:</strong> ${formatCurrency(netCash)}</p>
                </div>
            `;
            
            document.getElementById('cashFlow').innerHTML = html;
        }

        function generateCategoryAnalysis(transactions, startDate, endDate) {
            const byCategory = {};
            
            transactions.forEach(t => {
                if (!byCategory[t.category]) {
                    byCategory[t.category] = { income: 0, expense: 0 };
                }
                if (t.type === 'income') {
                    byCategory[t.category].income += parseFloat(t.amount);
                } else {
                    byCategory[t.category].expense += parseFloat(t.amount);
                }
            });
            
            let html = `
                <div style="font-family: 'Roboto Mono', monospace; font-size: 14px;">
                    <p><strong>Period:</strong> ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}</p>
                    <hr style="margin: 16px 0;">
            `;
            
            for (const [category, amounts] of Object.entries(byCategory)) {
                let displayValue = amounts.income - amounts.expense;
                html += `<p><strong>${category}:</strong> ${formatCurrency(displayValue)}</p>`;
            }
            
            html += '</div>';
            document.getElementById('categoryAnalysis').innerHTML = html;
        }

        // Tax Center
        function generateTaxSummary() {
            const year = parseInt(document.getElementById('taxYear').value);
            
            const yearTransactions = APP.transactions.filter(t => {
                return new Date(t.date).getFullYear() === year;
            });
            
            const totalIncome = yearTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const expensesByCategory = {};
            yearTransactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    if (!expensesByCategory[t.category]) {
                        expensesByCategory[t.category] = 0;
                    }
                    expensesByCategory[t.category] += parseFloat(t.amount);
                });
            
            const totalExpenses = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);
            const netProfit = totalIncome - totalExpenses;
            
            let html = `
                <div style="font-family: 'Roboto Mono', monospace;">
                    <h3>Schedule C - Tax Year ${year}</h3>
                    <hr style="margin: 16px 0;">
                    <h4>Gross Income</h4>
                    <p><strong>Total Income:</strong> ${formatCurrency(totalIncome)}</p>
                    <hr style="margin: 16px 0;">
                    <h4>Expenses</h4>
            `;
            
            for (const [category, amount] of Object.entries(expensesByCategory)) {
                html += `<p><strong>${category}:</strong> ${formatCurrency(amount)}</p>`;
            }
            
            html += `
                    <hr style="margin: 16px 0;">
                    <p><strong>Total Expenses:</strong> ${formatCurrency(totalExpenses)}</p>
                    <hr style="margin: 16px 0;">
                    <h4 style="font-size: 18px;"><strong>Net Profit:</strong> ${formatCurrency(netProfit)}</h4>
                </div>
            `;
            
            document.getElementById('taxSummary').innerHTML = html;
        }

        // Export Functions
        function exportToPDF(reportType) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            
            // Add business header if available
            const businessHeader = getBusinessHeader();
            if (businessHeader) {
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                const headerLines = businessHeader.trim().split('\n');
                headerLines.forEach(line => {
                    doc.text(line, 20, yPos);
                    yPos += 5;
                });
                yPos += 5;
                doc.setFont(undefined, 'normal');
            }
            
            // Header
            doc.setFontSize(20);
            doc.text('SmallBiz BookKeeping Pro', 20, yPos);
            yPos += 7;
            doc.setFontSize(12);
            doc.text(`Report Type: ${reportType.toUpperCase()}`, 20, yPos);
            yPos += 5;
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, yPos);
            yPos += 5;
            doc.text(`License: ${APP.licenseKey}`, 20, yPos);
            yPos += 10;
            
            if (reportType === 'income') {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const filtered = APP.transactions.filter(t => t.date >= startDate && t.date <= endDate);
                
                const income = filtered.filter(t => t.type === 'income');
                const expenses = filtered.filter(t => t.type === 'expense');
                const totalIncome = income.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                doc.setFontSize(16);
                doc.text('Income Statement', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.text(`Period: ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`, 20, yPos);
                yPos += 10;
                
                doc.setFontSize(12);
                doc.text('INCOME', 20, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                income.forEach(t => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`  ${t.date} - ${t.description}`, 20, yPos);
                    doc.text(`$${parseFloat(t.amount).toFixed(2)}`, 170, yPos);
                    yPos += 5;
                });
                
                yPos += 3;
                doc.setFontSize(11);
                doc.text('Total Income:', 20, yPos);
                doc.text(`$${totalIncome.toFixed(2)}`, 170, yPos);
                yPos += 10;
                
                doc.setFontSize(12);
                doc.text('EXPENSES', 20, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                expenses.forEach(t => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`  ${t.date} - ${t.description}`, 20, yPos);
                    doc.text(`$${parseFloat(t.amount).toFixed(2)}`, 170, yPos);
                    yPos += 5;
                });
                
                yPos += 3;
                doc.setFontSize(11);
                doc.text('Total Expenses:', 20, yPos);
                doc.text(`$${totalExpenses.toFixed(2)}`, 170, yPos);
                yPos += 10;
                
                doc.setFontSize(14);
                doc.text('NET INCOME:', 20, yPos);
                doc.text(`$${(totalIncome - totalExpenses).toFixed(2)}`, 170, yPos);
                
            } else if (reportType === 'cashflow') {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const filtered = APP.transactions.filter(t => t.date >= startDate && t.date <= endDate);
                
                const cashIn = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const cashOut = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                doc.setFontSize(16);
                doc.text('Cash Flow Statement', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.text(`Period: ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`, 20, yPos);
                yPos += 15;
                
                doc.setFontSize(12);
                doc.text('Cash Inflows:', 20, yPos);
                doc.text(`$${cashIn.toFixed(2)}`, 170, yPos);
                yPos += 10;
                
                doc.text('Cash Outflows:', 20, yPos);
                doc.text(`$${cashOut.toFixed(2)}`, 170, yPos);
                yPos += 15;
                
                doc.setFontSize(14);
                doc.text('Net Cash Flow:', 20, yPos);
                doc.text(`$${(cashIn - cashOut).toFixed(2)}`, 170, yPos);
                
            } else if (reportType === 'category') {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const filtered = APP.transactions.filter(t => t.date >= startDate && t.date <= endDate);
                
                const byCategory = {};
                filtered.forEach(t => {
                    if (!byCategory[t.category]) {
                        byCategory[t.category] = { income: 0, expense: 0 };
                    }
                    if (t.type === 'income') {
                        byCategory[t.category].income += parseFloat(t.amount);
                    } else {
                        byCategory[t.category].expense += parseFloat(t.amount);
                    }
                });
                
                doc.setFontSize(16);
                doc.text('Category Analysis', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.text(`Period: ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`, 20, yPos);
                yPos += 15;
                
                doc.setFontSize(11);
                for (const [category, amounts] of Object.entries(byCategory)) {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    const total = amounts.income - amounts.expense;
                    doc.text(`${category}:`, 20, yPos);
                    doc.text(`$${total.toFixed(2)}`, 170, yPos);
                    yPos += 7;
                }
                
            } else if (reportType === 'tax') {
                const year = parseInt(document.getElementById('taxYear').value);
                const yearTransactions = APP.transactions.filter(t => new Date(t.date).getFullYear() === year);
                
                const totalIncome = yearTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                const expensesByCategory = {};
                yearTransactions.filter(t => t.type === 'expense').forEach(t => {
                    if (!expensesByCategory[t.category]) {
                        expensesByCategory[t.category] = 0;
                    }
                    expensesByCategory[t.category] += parseFloat(t.amount);
                });
                
                const totalExpenses = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);
                const netProfit = totalIncome - totalExpenses;
                
                doc.setFontSize(16);
                doc.text(`Schedule C - Tax Year ${year}`, 20, yPos);
                yPos += 15;
                
                doc.setFontSize(13);
                doc.text('GROSS INCOME', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                doc.text('Total Income:', 20, yPos);
                doc.text(`$${totalIncome.toFixed(2)}`, 170, yPos);
                yPos += 15;
                
                doc.setFontSize(13);
                doc.text('EXPENSES', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                for (const [category, amount] of Object.entries(expensesByCategory)) {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`${category}:`, 20, yPos);
                    doc.text(`$${amount.toFixed(2)}`, 170, yPos);
                    yPos += 6;
                }
                
                yPos += 5;
                doc.setFontSize(11);
                doc.text('Total Expenses:', 20, yPos);
                doc.text(`$${totalExpenses.toFixed(2)}`, 170, yPos);
                yPos += 15;
                
                doc.setFontSize(14);
                doc.text('NET PROFIT:', 20, yPos);
                doc.text(`$${netProfit.toFixed(2)}`, 170, yPos);
            }
            
            doc.save(`${reportType}-report-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(APP.transactions);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
            XLSX.writeFile(wb, 'transactions.xlsx');
        }

        // Import Functions
        function downloadTemplate() {
            const template = [
                {
                    date: '2025-02-06',
                    type: 'income',
                    category: 'Sales',
                    description: 'Sample income transaction',
                    amount: 1000.00,
                    notes: 'Optional notes field'
                },
                {
                    date: '2025-02-06',
                    type: 'expense',
                    category: 'Office Expense',
                    description: 'Sample expense transaction',
                    amount: 150.00,
                    notes: 'Optional notes field'
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'import-template.xlsx');
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            const fileName = file.name.toLowerCase();
            
            reader.onload = function(e) {
                try {
                    let importedData = [];
                    
                    if (fileName.endsWith('.csv')) {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const values = lines[i].split(',');
                            const transaction = {};
                            
                            headers.forEach((header, index) => {
                                transaction[header] = values[index]?.trim() || '';
                            });
                            
                            importedData.push(transaction);
                        }
                    } else {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        importedData = XLSX.utils.sheet_to_json(firstSheet);
                    }
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let transactionsToAdd = [];
                    
                    importedData.forEach((row, index) => {
                        try {
                            const rowKeys = Object.keys(row);
                            
                            const dateKey = rowKeys.find(k => /date/i.test(k));
                            const typeKey = rowKeys.find(k => /type/i.test(k));
                            const categoryKey = rowKeys.find(k => /category/i.test(k));
                            const descKey = rowKeys.find(k => /desc/i.test(k));
                            const amountKey = rowKeys.find(k => /amount/i.test(k));
                            const notesKey = rowKeys.find(k => /note/i.test(k));
                            
                            let dateValue = row[dateKey] || new Date().toISOString().split('T')[0];
                            
                            if (typeof dateValue === 'number') {
                                const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
                                dateValue = excelDate.toISOString().split('T')[0];
                            } else if (dateValue instanceof Date) {
                                dateValue = dateValue.toISOString().split('T')[0];
                            }
                            
                            const transaction = {
                                date: dateValue,
                                type: (row[typeKey] || 'expense').toString().toLowerCase().trim(),
                                category: row[categoryKey] || 'Other Expenses',
                                description: row[descKey] || 'Imported',
                                amount: Math.abs(parseFloat(row[amountKey] || 0)),
                                notes: (row[notesKey] || '').toString()
                            };
                            
                            if (!transaction.date || !transaction.amount || transaction.amount <= 0) {
                                errorCount++;
                                return;
                            }
                            
                            if (!['income', 'expense'].includes(transaction.type)) {
                                transaction.type = 'expense';
                            }
                            
                            transaction.id = Date.now().toString() + '-' + index;
                            transactionsToAdd.push(transaction);
                            successCount++;
                        } catch (err) {
                            errorCount++;
                        }
                    });
                    
                    APP.transactions.push(...transactionsToAdd);
                    saveData();
                    renderTransactions();
                    updateDashboard();
                    
                    let message = `Import complete!\n\n‚úÖ Successfully imported: ${successCount} transactions`;
                    if (errorCount > 0) {
                        message += `\n‚ùå Errors/Skipped: ${errorCount}`;
                    }
                    
                    alert(message);
                    event.target.value = '';
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing file. Please check the file format.');
                    event.target.value = '';
                }
            };
            
            if (fileName.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // Initialize App
        function initializeApp() {
            updateDashboard();
            renderTransactions();
            populateCategoryFilter();
            setDefaultDates();
            updateDataStatus();
        }

        function populateCategoryFilter() {
            const select = document.getElementById('filterCategory');
            const allCategories = [...APP.categories.income, ...APP.categories.expense];
            select.innerHTML = '<option value="all">All Categories</option>' +
                allCategories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function setDefaultDates() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = lastDay.toISOString().split('T')[0];
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Check license on load
            if (await checkLicense()) {
                showMainApp();
            }
            
            // License activation
            document.getElementById('activateBtn').addEventListener('click', async () => {
                const key = document.getElementById('licenseKeyInput').value.trim().toUpperCase();
                await activateLicense(key);
            });
            
            document.getElementById('licenseKeyInput').addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    const key = document.getElementById('licenseKeyInput').value.trim().toUpperCase();
                    await activateLicense(key);
                }
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
                    
                    // Update data status when viewing settings
                    if (btn.dataset.tab === 'settings') {
                        updateDataStatus();
                    }
                });
            });
            
            // Transaction modal
            document.getElementById('addTransactionBtn').addEventListener('click', () => showTransactionModal());
            document.querySelector('.close').addEventListener('click', hideTransactionModal);
            document.querySelector('.cancel-btn').addEventListener('click', hideTransactionModal);
            
            // Transaction form
            document.getElementById('txType').addEventListener('change', (e) => {
                updateCategoryOptions(e.target.value);
            });
            
            document.getElementById('transactionForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const transaction = {
                    date: document.getElementById('txDate').value,
                    type: document.getElementById('txType').value,
                    category: document.getElementById('txCategory').value,
                    description: document.getElementById('txDescription').value,
                    amount: document.getElementById('txAmount').value,
                    notes: document.getElementById('txNotes').value
                };
                
                if (APP.editingTransactionId) {
                    updateTransaction(APP.editingTransactionId, transaction);
                } else {
                    addTransaction(transaction);
                }
                
                hideTransactionModal();
            });
            
            // Filters
            document.getElementById('searchTransaction').addEventListener('input', renderTransactions);
            document.getElementById('filterType').addEventListener('change', renderTransactions);
            document.getElementById('filterCategory').addEventListener('change', renderTransactions);
            
            // Bulk actions
            document.getElementById('selectAllBtn').addEventListener('click', () => {
                document.querySelectorAll('.transaction-checkbox').forEach(cb => cb.checked = true);
            });
            
            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedTransactions);
            
            document.getElementById('exportSelectedBtn').addEventListener('click', () => {
                const selected = Array.from(document.querySelectorAll('.transaction-checkbox:checked'))
                    .map(cb => APP.transactions.find(t => t.id === cb.dataset.id));
                
                if (selected.length === 0) {
                    alert('Please select transactions to export');
                    return;
                }
                
                const ws = XLSX.utils.json_to_sheet(selected);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Selected Transactions');
                XLSX.writeFile(wb, 'selected-transactions.xlsx');
            });
            
            // Import functionality
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            
            document.getElementById('fileInput').addEventListener('change', handleFileImport);
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
            
            // Reports
            document.getElementById('generateReportBtn').addEventListener('click', generateReports);
            
            document.querySelectorAll('.export-pdf').forEach(btn => {
                btn.addEventListener('click', () => {
                    exportToPDF(btn.dataset.report);
                });
            });
            
            // Tax
            document.getElementById('generateTaxBtn').addEventListener('click', generateTaxSummary);
            document.getElementById('exportTaxPdfBtn').addEventListener('click', () => exportToPDF('tax'));
            document.getElementById('exportTaxExcelBtn').addEventListener('click', exportToExcel);
            
            // Settings
            document.getElementById('settingsForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveSettings();
            });
            
            document.getElementById('clearSettingsBtn').addEventListener('click', clearSettings);
        });
    </script>
</body>
</html>
