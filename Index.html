<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>SmallBiz BookKeeping Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #eef2ff;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* License Screen */
        .license-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .license-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .license-container {
            background: white;
            border-radius: 24px;
            padding: 56px;
            max-width: 520px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
        }

        .license-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .license-header h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
        }

        .license-form {
            margin-bottom: 32px;
        }

        .license-form h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .license-form input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
        }

        .license-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
            transform: translateY(-1px);
        }

        .license-message {
            margin-top: 16px;
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .license-message.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            display: block;
            border: 2px solid #10b981;
        }

        .license-message.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            display: block;
            border: 2px solid #ef4444;
        }

        .license-footer {
            text-align: center;
            padding-top: 28px;
            border-top: 2px solid var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
        }

        .license-footer p:first-child {
            color: var(--text-primary);
            font-size: 16px;
        }

        /* Main Application */
        .main-app {
            min-height: 100vh;
            display: none;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 20px 0;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .license-info {
            font-size: 13px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        /* Navigation */
        .main-nav {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            display: flex;
            gap: 4px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }

        .nav-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .nav-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--primary-light);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 32px 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Buttons */
        .btn-primary, .btn-secondary, .btn-danger {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-secondary);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }

        .chart-container {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        /* Transactions */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .section-header h2 {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--text-primary);
        }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters input,
        .filters select {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .filters input:focus,
        .filters select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .filters input {
            flex: 1;
            min-width: 200px;
        }

        .bulk-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .transactions-list {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
            overflow: hidden;
        }

        .transaction-header {
            display: grid;
            grid-template-columns: 40px 110px 90px 140px 2fr 130px 140px;
            gap: 20px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
            font-size: 13px;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transaction-item {
            display: grid;
            grid-template-columns: 40px 110px 90px 140px 2fr 130px 140px;
            gap: 20px;
            padding: 20px;
            border-bottom: 1px solid var(--bg-tertiary);
            align-items: center;
            transition: all 0.2s ease;
        }

        .transaction-item:hover {
            background: var(--bg-secondary);
            transform: translateX(2px);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-date {
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .transaction-category {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .transaction-description {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .transaction-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .transaction-type {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.3px;
        }

        .transaction-type.income {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #10b981;
        }

        .transaction-type.expense {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .transaction-amount {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
        }

        .transaction-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* Reports */
        .report-controls {
            background: white;
            padding: 28px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .report-controls label {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .report-controls input {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
        }

        .report-controls input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
        }

        .report-card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .report-card h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .report-card .export-pdf {
            margin-top: 20px;
            width: 100%;
        }

        /* Tax Center */
        .tax-controls {
            background: white;
            padding: 28px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            align-items: flex-end;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .tax-controls label {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .tax-controls select {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
        }

        .tax-controls select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .tax-summary {
            background: white;
            padding: 28px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .tax-actions {
            display: flex;
            gap: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 540px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 28px;
            border-bottom: 2px solid var(--bg-tertiary);
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .close {
            font-size: 32px;
            font-weight: 300;
            color: var(--text-muted);
            cursor: pointer;
            line-height: 1;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .close:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .modal-content form {
            padding: 28px;
        }

        .modal-content label {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.3s ease;
        }

        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .modal-content textarea {
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .modal-actions button {
            flex: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            
            .main-nav {
                overflow-x: auto;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .transaction-header {
                display: none;
            }
            
            .transaction-item {
                grid-template-columns: 40px 1fr 100px;
                gap: 12px;
            }
            
            .transaction-item .transaction-category,
            .transaction-item .transaction-description {
                display: none;
            }
            
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .license-container {
                padding: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- License Activation Screen -->
    <div id="licenseScreen" class="license-screen">
        <div class="license-container">
            <div class="license-header">
                <h1>SmallBiz BookKeeping Pro</h1>
                <p class="tagline">Professional Accounting for Small Businesses</p>
            </div>
            <div class="license-form">
                <h2>Activate Your License</h2>
                <input type="text" id="licenseKeyInput" placeholder="Enter your license key" maxlength="19">
                <button id="activateBtn" class="btn-primary">Activate License</button>
                <p class="license-message" id="licenseMessage"></p>
            </div>
            <div class="license-footer">
                <p>Single License Purchase: $250</p>
                <p style="margin-top: 12px; font-size: 12px;">Demo Key: 7Y5L-KSGG-8288-WAMQ</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1>SmallBiz BookKeeping Pro</h1>
                <div class="header-actions">
                    <span class="license-info" id="licenseInfo"></span>
                    <button id="logoutBtn" class="btn-secondary">Logout</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="main-nav">
            <button class="nav-btn active" data-tab="dashboard">Dashboard</button>
            <button class="nav-btn" data-tab="transactions">Transactions</button>
            <button class="nav-btn" data-tab="reports">Reports</button>
            <button class="nav-btn" data-tab="tax">Tax Center</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Tab -->
            <section id="dashboardTab" class="tab-content active">
                <h2>Dashboard Overview</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <p class="stat-value" id="totalRevenue">$0.00</p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Expenses</h3>
                        <p class="stat-value" id="totalExpenses">$0.00</p>
                    </div>
                    <div class="stat-card">
                        <h3>Net Income</h3>
                        <p class="stat-value" id="netIncome">$0.00</p>
                    </div>
                    <div class="stat-card">
                        <h3>Transactions</h3>
                        <p class="stat-value" id="totalTransactions">0</p>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Monthly Trend</h3>
                    <canvas id="monthlyChart"></canvas>
                </div>
            </section>

            <!-- Transactions Tab -->
            <section id="transactionsTab" class="tab-content">
                <div class="section-header">
                    <h2>Transactions</h2>
                    <button id="addTransactionBtn" class="btn-primary">Add Transaction</button>
                </div>
                
                <div class="filters">
                    <input type="text" id="searchTransaction" placeholder="Search transactions...">
                    <select id="filterType">
                        <option value="all">All Types</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                    <select id="filterCategory">
                        <option value="all">All Categories</option>
                    </select>
                </div>

                <div class="bulk-actions">
                    <button id="selectAllBtn" class="btn-secondary">Select All</button>
                    <button id="deleteSelectedBtn" class="btn-danger">Delete Selected</button>
                    <button id="exportSelectedBtn" class="btn-secondary">Export Selected</button>
                    <button id="importBtn" class="btn-primary">Import CSV/Excel</button>
                    <button id="downloadTemplateBtn" class="btn-secondary">Download Template</button>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>

                <div class="transactions-list" id="transactionsList">
                    <!-- Header and transactions will be rendered here -->
                </div>
            </section>

            <!-- Reports Tab -->
            <section id="reportsTab" class="tab-content">
                <h2>Financial Reports</h2>
                <div class="report-controls">
                    <label>
                        Start Date:
                        <input type="date" id="reportStartDate">
                    </label>
                    <label>
                        End Date:
                        <input type="date" id="reportEndDate">
                    </label>
                    <button id="generateReportBtn" class="btn-primary">Generate Reports</button>
                </div>

                <div class="reports-grid">
                    <div class="report-card">
                        <h3>Income Statement</h3>
                        <div id="incomeStatement"></div>
                        <button class="btn-secondary export-pdf" data-report="income">Export PDF</button>
                    </div>
                    <div class="report-card">
                        <h3>Cash Flow</h3>
                        <div id="cashFlow"></div>
                        <button class="btn-secondary export-pdf" data-report="cashflow">Export PDF</button>
                    </div>
                    <div class="report-card">
                        <h3>Category Analysis</h3>
                        <div id="categoryAnalysis"></div>
                        <button class="btn-secondary export-pdf" data-report="category">Export PDF</button>
                    </div>
                </div>
            </section>

            <!-- Tax Center Tab -->
            <section id="taxTab" class="tab-content">
                <h2>Tax Center - Schedule C</h2>
                <div class="tax-controls">
                    <label>
                        Tax Year:
                        <select id="taxYear">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </label>
                    <button id="generateTaxBtn" class="btn-primary">Generate Tax Summary</button>
                </div>

                <div class="tax-summary" id="taxSummary">
                    <!-- Tax summary will be rendered here -->
                </div>

                <div class="tax-actions">
                    <button id="exportTaxPdfBtn" class="btn-primary">Export Tax PDF</button>
                    <button id="exportTaxExcelBtn" class="btn-secondary">Export to Excel</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Transaction</h2>
                <span class="close">&times;</span>
            </div>
            <form id="transactionForm">
                <label>
                    Date:
                    <input type="date" id="txDate" required>
                </label>
                <label>
                    Type:
                    <select id="txType" required>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </label>
                <label>
                    Category:
                    <select id="txCategory" required>
                        <!-- Categories will be populated dynamically -->
                    </select>
                </label>
                <label>
                    Description:
                    <input type="text" id="txDescription" required>
                </label>
                <label>
                    Amount:
                    <input type="number" id="txAmount" step="0.01" min="0" required>
                </label>
                <label>
                    Notes:
                    <textarea id="txNotes" rows="3"></textarea>
                </label>
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Save Transaction</button>
                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // ============================================
        // ADVANCED LICENSE AUTHENTICATION SYSTEM
        // ============================================
        
        class LicenseAuth {
            constructor() {
                this.licenseKey = null;
                this.deviceFingerprint = null;
                this.validLicenses = this.initializeLicenseDatabase();
            }

            initializeLicenseDatabase() {
                return {
                    // Demo/Trial Licenses
                    'SBKP-2025-XXXX-TRIAL': {
                        type: 'trial',
                        deviceFingerprint: null,
                        activatedAt: null,
                        expiresAt: null,
                        features: ['all'],
                        buyer: 'Trial User',
                        email: 'trial@example.com'
                    },
                    
                    // Customer Licenses
                    '857Y-M4WG-M3H3-NDR7': {
                        type: 'SINGLE',
                        deviceFingerprint: null,
                        activatedAt: null,
                        expiresAt: null,
                        features: ['all'],
                        buyer: 'Peter King Ofori',
                        email: 'Peterkin@hotmail.com',
                        generated: '2026-02-05T17:23:08.549Z'
                    },
                    '7Y5L-KSGG-8288-WAMQ': {
                        type: 'DEMO',
                        deviceFingerprint: null,
                        activatedAt: null,
                        expiresAt: null,
                        features: ['all'],
                        buyer: 'Alma Agra',
                        email: 'almaa.wfg@gmail.com',
                        generated: '2026-02-05T17:57:07.478Z'
                    },
                    'D9VF-JSDK-XUMV-F2BZ': {
                        type: 'SINGLE',
                        deviceFingerprint: null,
                        activatedAt: null,
                        expiresAt: null,
                        features: ['all'],
                        buyer: 'Kofi',
                        email: 'kobengasiedu@aarp.org',
                        generated: '2026-02-06T01:09:17.959Z'
                    }
                };
            }

            async generateDeviceFingerprint() {
                const components = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    languages: navigator.languages ? navigator.languages.join(',') : '',
                    platform: navigator.platform,
                    screenResolution: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneOffset: new Date().getTimezoneOffset(),
                    hardwareConcurrency: navigator.hardwareConcurrency || 0,
                    deviceMemory: navigator.deviceMemory || 0,
                    canvasFingerprint: await this.getCanvasFingerprint(),
                    webglFingerprint: this.getWebGLFingerprint()
                };

                const fingerprint = JSON.stringify(components);
                return this.hashString(fingerprint);
            }

            async getCanvasFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = 200;
                    canvas.height = 50;
                    
                    ctx.textBaseline = 'top';
                    ctx.font = '14px "Arial"';
                    ctx.textBaseline = 'alphabetic';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = '#069';
                    ctx.fillText('SmallBiz BookKeeping Pro üîê', 2, 15);
                    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                    ctx.fillText('SmallBiz BookKeeping Pro üîê', 4, 17);

                    const dataURL = canvas.toDataURL();
                    return this.hashString(dataURL);
                } catch (e) {
                    return 'canvas-unavailable';
                }
            }

            getWebGLFingerprint() {
                try {
                    const canvas = document.createElement('canvas');
                    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    
                    if (!gl) return 'webgl-unavailable';

                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';
                    const vendor = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'unknown';

                    return this.hashString(`${renderer}-${vendor}`);
                } catch (e) {
                    return 'webgl-unavailable';
                }
            }

            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }

            validateLicenseFormat(key) {
                // Accept SBKP format: SBKP-YYYY-XXXX-XXXXX
                const sbkpPattern = /^SBKP-\d{4}-[A-Z0-9]{4}-[A-Z0-9]{5}$/;
                // Accept custom format: XXXX-XXXX-XXXX-XXXX
                const customPattern = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
                
                return sbkpPattern.test(key) || customPattern.test(key);
            }

            async activateLicense(licenseKey) {
                if (!this.validateLicenseFormat(licenseKey)) {
                    return {
                        success: false,
                        error: 'Invalid license key format'
                    };
                }

                const licenseData = this.validLicenses[licenseKey];
                if (!licenseData) {
                    return {
                        success: false,
                        error: 'Invalid license key'
                    };
                }

                const deviceFP = await this.generateDeviceFingerprint();

                if (licenseData.deviceFingerprint && licenseData.deviceFingerprint !== deviceFP) {
                    return {
                        success: false,
                        error: 'This license is already activated on another device'
                    };
                }

                licenseData.deviceFingerprint = deviceFP;
                licenseData.activatedAt = new Date().toISOString();

                this.licenseKey = licenseKey;
                this.deviceFingerprint = deviceFP;

                this.saveLicenseData();

                return {
                    success: true,
                    licenseType: licenseData.type,
                    features: licenseData.features
                };
            }

            async verifyLicense() {
                const savedLicense = localStorage.getItem('sbkp_license');
                const savedFingerprint = localStorage.getItem('sbkp_fingerprint');

                if (!savedLicense || !savedFingerprint) {
                    return false;
                }

                const licenseData = this.validLicenses[savedLicense];
                if (!licenseData) {
                    return false;
                }

                const currentFingerprint = await this.generateDeviceFingerprint();

                if (savedFingerprint !== currentFingerprint) {
                    return false;
                }

                this.licenseKey = savedLicense;
                this.deviceFingerprint = savedFingerprint;
                return true;
            }

            deactivateLicense() {
                if (this.licenseKey && this.validLicenses[this.licenseKey]) {
                    this.validLicenses[this.licenseKey].deviceFingerprint = null;
                    this.validLicenses[this.licenseKey].activatedAt = null;
                }

                localStorage.removeItem('sbkp_license');
                localStorage.removeItem('sbkp_fingerprint');
                
                this.licenseKey = null;
                this.deviceFingerprint = null;
            }

            saveLicenseData() {
                localStorage.setItem('sbkp_license', this.licenseKey);
                localStorage.setItem('sbkp_fingerprint', this.deviceFingerprint);
            }

            getLicenseInfo() {
                if (!this.licenseKey) return null;

                const licenseData = this.validLicenses[this.licenseKey];
                return {
                    key: this.licenseKey,
                    type: licenseData.type,
                    features: licenseData.features,
                    activatedAt: licenseData.activatedAt
                };
            }

            static generateLicenseKey() {
                const year = new Date().getFullYear();
                const random1 = Math.random().toString(36).substring(2, 6).toUpperCase();
                const random2 = Math.random().toString(36).substring(2, 7).toUpperCase();
                return `SBKP-${year}-${random1}-${random2}`;
            }
        }

        // ============================================
        // APPLICATION CODE
        // ============================================
        
        // Application State
        const APP = {
            version: '1.0.0',
            licenseKey: null,
            transactions: [],
            categories: {
                income: ['Sales', 'Services', 'Consulting', 'Products', 'Other Income'],
                expense: ['Advertising', 'Car & Truck', 'Commissions', 'Contract Labor', 'Depreciation', 
                          'Employee Benefits', 'Insurance', 'Legal & Professional', 'Office Expense', 
                          'Rent', 'Repairs & Maintenance', 'Supplies', 'Travel', 'Meals', 'Utilities', 
                          'Wages', 'Other Expenses']
            },
            chart: null,
            editingTransactionId: null
        };

        // Initialize Advanced License System
        const licenseAuth = new LicenseAuth();

        // License Management Functions
        async function activateLicense(licenseKey) {
            console.log('üîë Attempting to activate license:', licenseKey);
            const messageEl = document.getElementById('licenseMessage');
            
            try {
                const result = await licenseAuth.activateLicense(licenseKey);
                console.log('üìã Activation result:', result);
                
                if (result.success) {
                    messageEl.textContent = 'License activated successfully!';
                    messageEl.className = 'license-message success';
                    
                    APP.licenseKey = licenseKey;
                    
                    setTimeout(() => {
                        showMainApp();
                    }, 1000);
                } else {
                    messageEl.textContent = result.error;
                    messageEl.className = 'license-message error';
                }
            } catch (error) {
                console.error('‚ùå License activation error:', error);
                messageEl.textContent = 'Error: ' + error.message;
                messageEl.className = 'license-message error';
            }
        }

        async function checkLicense() {
            const isValid = await licenseAuth.verifyLicense();
            if (isValid) {
                APP.licenseKey = licenseAuth.licenseKey;
            }
            return isValid;
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                licenseAuth.deactivateLicense();
                location.reload();
            }
        }

        function showMainApp() {
            document.getElementById('licenseScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('licenseInfo').textContent = `License: ${APP.licenseKey}`;
            loadData();
            initializeApp();
        }

        // Data Management
        function saveData() {
            localStorage.setItem('sbkp_transactions', JSON.stringify(APP.transactions));
        }

        function loadData() {
            const saved = localStorage.getItem('sbkp_transactions');
            if (saved) {
                APP.transactions = JSON.parse(saved);
            }
        }

        // Transaction Management
        function addTransaction(transaction) {
            transaction.id = Date.now().toString();
            APP.transactions.push(transaction);
            saveData();
            renderTransactions();
            updateDashboard();
        }

        function updateTransaction(id, transaction) {
            const index = APP.transactions.findIndex(t => t.id === id);
            if (index !== -1) {
                transaction.id = id;
                APP.transactions[index] = transaction;
                saveData();
                renderTransactions();
                updateDashboard();
            }
        }

        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                APP.transactions = APP.transactions.filter(t => t.id !== id);
                saveData();
                renderTransactions();
                updateDashboard();
            }
        }

        function deleteSelectedTransactions() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select transactions to delete');
                return;
            }
            
            if (confirm(`Delete ${checkboxes.length} selected transaction(s)?`)) {
                checkboxes.forEach(cb => {
                    APP.transactions = APP.transactions.filter(t => t.id !== cb.dataset.id);
                });
                saveData();
                renderTransactions();
                updateDashboard();
            }
        }

        // Rendering
        function renderTransactions() {
            const container = document.getElementById('transactionsList');
            const searchTerm = document.getElementById('searchTransaction').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            
            let filtered = APP.transactions.filter(t => {
                const matchesSearch = t.description.toLowerCase().includes(searchTerm) || 
                                    (t.notes && t.notes.toLowerCase().includes(searchTerm));
                const matchesType = typeFilter === 'all' || t.type === typeFilter;
                const matchesCategory = categoryFilter === 'all' || t.category === categoryFilter;
                return matchesSearch && matchesType && matchesCategory;
            });
            
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const header = `
                <div class="transaction-header">
                    <div></div>
                    <div>Date</div>
                    <div>Type</div>
                    <div>Category</div>
                    <div>Description</div>
                    <div>Amount</div>
                    <div>Actions</div>
                </div>
            `;
            
            if (filtered.length === 0) {
                container.innerHTML = header + '<div style="padding: 32px; text-align: center; color: var(--text-secondary);">No transactions found</div>';
                return;
            }
            
            const rows = filtered.map(t => `
                <div class="transaction-item">
                    <input type="checkbox" class="transaction-checkbox" data-id="${t.id}">
                    <div class="transaction-date">${new Date(t.date).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })}</div>
                    <div class="transaction-type ${t.type}">${t.type}</div>
                    <div class="transaction-category">${t.category}</div>
                    <div class="transaction-description">${t.description}</div>
                    <div class="transaction-amount">$${parseFloat(t.amount).toFixed(2)}</div>
                    <div class="transaction-actions">
                        <button class="action-btn" onclick="editTransaction('${t.id}')">Edit</button>
                        <button class="action-btn" onclick="deleteTransaction('${t.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = header + rows;
        }

        function updateDashboard() {
            const income = APP.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const expenses = APP.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            document.getElementById('totalRevenue').textContent = `$${income.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `$${expenses.toFixed(2)}`;
            document.getElementById('netIncome').textContent = `$${(income - expenses).toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = APP.transactions.length;
            
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;
            
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    label: d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                    year: d.getFullYear(),
                    month: d.getMonth()
                });
            }
            
            const monthlyData = months.map(m => {
                const income = APP.transactions
                    .filter(t => {
                        const d = new Date(t.date);
                        return t.type === 'income' && d.getFullYear() === m.year && d.getMonth() === m.month;
                    })
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                const expense = APP.transactions
                    .filter(t => {
                        const d = new Date(t.date);
                        return t.type === 'expense' && d.getFullYear() === m.year && d.getMonth() === m.month;
                    })
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                return { income, expense };
            });
            
            if (APP.chart) {
                APP.chart.destroy();
            }
            
            APP.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months.map(m => m.label),
                    datasets: [
                        {
                            label: 'Income',
                            data: monthlyData.map(d => d.income),
                            backgroundColor: 'rgba(16, 185, 129, 0.8)'
                        },
                        {
                            label: 'Expenses',
                            data: monthlyData.map(d => d.expense),
                            backgroundColor: 'rgba(239, 68, 68, 0.8)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Modal Management
        function showTransactionModal(transactionId = null) {
            const modal = document.getElementById('transactionModal');
            const form = document.getElementById('transactionForm');
            
            APP.editingTransactionId = transactionId;
            
            if (transactionId) {
                const transaction = APP.transactions.find(t => t.id === transactionId);
                document.getElementById('modalTitle').textContent = 'Edit Transaction';
                document.getElementById('txDate').value = transaction.date;
                document.getElementById('txType').value = transaction.type;
                updateCategoryOptions(transaction.type);
                document.getElementById('txCategory').value = transaction.category;
                document.getElementById('txDescription').value = transaction.description;
                document.getElementById('txAmount').value = transaction.amount;
                document.getElementById('txNotes').value = transaction.notes || '';
            } else {
                document.getElementById('modalTitle').textContent = 'Add Transaction';
                form.reset();
                document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
                updateCategoryOptions('income');
            }
            
            modal.classList.add('show');
        }

        function hideTransactionModal() {
            document.getElementById('transactionModal').classList.remove('show');
            APP.editingTransactionId = null;
        }

        function updateCategoryOptions(type) {
            const categorySelect = document.getElementById('txCategory');
            const categories = APP.categories[type] || [];
            categorySelect.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function editTransaction(id) {
            showTransactionModal(id);
        }

        // Reports
        function generateReports() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const filtered = APP.transactions.filter(t => {
                return t.date >= startDate && t.date <= endDate;
            });
            
            generateIncomeStatement(filtered, startDate, endDate);
            generateCashFlow(filtered, startDate, endDate);
            generateCategoryAnalysis(filtered, startDate, endDate);
        }

        function generateIncomeStatement(transactions, startDate, endDate) {
            const income = transactions.filter(t => t.type === 'income');
            const expenses = transactions.filter(t => t.type === 'expense');
            
            const totalIncome = income.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const netIncome = totalIncome - totalExpenses;
            
            const html = `
                <div style="font-family: 'Roboto Mono', monospace; font-size: 14px;">
                    <p><strong>Period:</strong> ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}</p>
                    <hr style="margin: 16px 0;">
                    <p><strong>Total Income:</strong> $${totalIncome.toFixed(2)}</p>
                    <p><strong>Total Expenses:</strong> $${totalExpenses.toFixed(2)}</p>
                    <hr style="margin: 16px 0;">
                    <p style="font-size: 16px;"><strong>Net Income:</strong> $${netIncome.toFixed(2)}</p>
                </div>
            `;
            
            document.getElementById('incomeStatement').innerHTML = html;
        }

        function generateCashFlow(transactions, startDate, endDate) {
            const income = transactions.filter(t => t.type === 'income');
            const expenses = transactions.filter(t => t.type === 'expense');
            
            const cashIn = income.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const cashOut = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const netCash = cashIn - cashOut;
            
            const html = `
                <div style="font-family: 'Roboto Mono', monospace; font-size: 14px;">
                    <p><strong>Period:</strong> ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}</p>
                    <hr style="margin: 16px 0;">
                    <p><strong>Cash In:</strong> $${cashIn.toFixed(2)}</p>
                    <p><strong>Cash Out:</strong> $${cashOut.toFixed(2)}</p>
                    <hr style="margin: 16px 0;">
                    <p style="font-size: 16px;"><strong>Net Cash Flow:</strong> $${netCash.toFixed(2)}</p>
                </div>
            `;
            
            document.getElementById('cashFlow').innerHTML = html;
        }

        function generateCategoryAnalysis(transactions, startDate, endDate) {
            const byCategory = {};
            
            transactions.forEach(t => {
                if (!byCategory[t.category]) {
                    byCategory[t.category] = { income: 0, expense: 0 };
                }
                if (t.type === 'income') {
                    byCategory[t.category].income += parseFloat(t.amount);
                } else {
                    byCategory[t.category].expense += parseFloat(t.amount);
                }
            });
            
            let html = `
                <div style="font-family: 'Roboto Mono', monospace; font-size: 14px;">
                    <p><strong>Period:</strong> ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}</p>
                    <hr style="margin: 16px 0;">
            `;
            
            for (const [category, amounts] of Object.entries(byCategory)) {
                const total = amounts.income - amounts.expense;
                html += `<p><strong>${category}:</strong> $${total.toFixed(2)}</p>`;
            }
            
            html += '</div>';
            document.getElementById('categoryAnalysis').innerHTML = html;
        }

        // Tax Center
        function generateTaxSummary() {
            const year = parseInt(document.getElementById('taxYear').value);
            
            const yearTransactions = APP.transactions.filter(t => {
                return new Date(t.date).getFullYear() === year;
            });
            
            const totalIncome = yearTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const expensesByCategory = {};
            yearTransactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    if (!expensesByCategory[t.category]) {
                        expensesByCategory[t.category] = 0;
                    }
                    expensesByCategory[t.category] += parseFloat(t.amount);
                });
            
            const totalExpenses = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);
            const netProfit = totalIncome - totalExpenses;
            
            let html = `
                <div style="font-family: 'Roboto Mono', monospace;">
                    <h3>Schedule C - Tax Year ${year}</h3>
                    <hr style="margin: 16px 0;">
                    <h4>Gross Income</h4>
                    <p><strong>Total Income:</strong> $${totalIncome.toFixed(2)}</p>
                    <hr style="margin: 16px 0;">
                    <h4>Expenses</h4>
            `;
            
            for (const [category, amount] of Object.entries(expensesByCategory)) {
                html += `<p><strong>${category}:</strong> $${amount.toFixed(2)}</p>`;
            }
            
            html += `
                    <hr style="margin: 16px 0;">
                    <p><strong>Total Expenses:</strong> $${totalExpenses.toFixed(2)}</p>
                    <hr style="margin: 16px 0;">
                    <h4 style="font-size: 18px;"><strong>Net Profit:</strong> $${netProfit.toFixed(2)}</h4>
                </div>
            `;
            
            document.getElementById('taxSummary').innerHTML = html;
        }

        // Export Functions
        function exportToPDF(reportType) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('SmallBiz BookKeeping Pro', 20, 20);
            doc.setFontSize(12);
            doc.text(`Report Type: ${reportType.toUpperCase()}`, 20, 30);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 37);
            doc.text(`License: ${APP.licenseKey}`, 20, 44);
            
            let yPos = 55;
            
            if (reportType === 'income') {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const filtered = APP.transactions.filter(t => t.date >= startDate && t.date <= endDate);
                
                const income = filtered.filter(t => t.type === 'income');
                const expenses = filtered.filter(t => t.type === 'expense');
                const totalIncome = income.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                doc.setFontSize(16);
                doc.text('Income Statement', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.text(`Period: ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`, 20, yPos);
                yPos += 10;
                
                doc.setFontSize(12);
                doc.text('INCOME', 20, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                income.forEach(t => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`  ${t.date} - ${t.description}`, 20, yPos);
                    doc.text(`$${parseFloat(t.amount).toFixed(2)}`, 170, yPos);
                    yPos += 5;
                });
                
                yPos += 3;
                doc.setFontSize(11);
                doc.text('Total Income:', 20, yPos);
                doc.text(`$${totalIncome.toFixed(2)}`, 170, yPos);
                yPos += 10;
                
                doc.setFontSize(12);
                doc.text('EXPENSES', 20, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                expenses.forEach(t => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`  ${t.date} - ${t.description}`, 20, yPos);
                    doc.text(`$${parseFloat(t.amount).toFixed(2)}`, 170, yPos);
                    yPos += 5;
                });
                
                yPos += 3;
                doc.setFontSize(11);
                doc.text('Total Expenses:', 20, yPos);
                doc.text(`$${totalExpenses.toFixed(2)}`, 170, yPos);
                yPos += 10;
                
                doc.setFontSize(14);
                doc.text('NET INCOME:', 20, yPos);
                doc.text(`$${(totalIncome - totalExpenses).toFixed(2)}`, 170, yPos);
                
            } else if (reportType === 'cashflow') {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const filtered = APP.transactions.filter(t => t.date >= startDate && t.date <= endDate);
                
                const cashIn = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const cashOut = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                doc.setFontSize(16);
                doc.text('Cash Flow Statement', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.text(`Period: ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`, 20, yPos);
                yPos += 15;
                
                doc.setFontSize(12);
                doc.text('Cash Inflows:', 20, yPos);
                doc.text(`$${cashIn.toFixed(2)}`, 170, yPos);
                yPos += 10;
                
                doc.text('Cash Outflows:', 20, yPos);
                doc.text(`$${cashOut.toFixed(2)}`, 170, yPos);
                yPos += 15;
                
                doc.setFontSize(14);
                doc.text('Net Cash Flow:', 20, yPos);
                doc.text(`$${(cashIn - cashOut).toFixed(2)}`, 170, yPos);
                
            } else if (reportType === 'category') {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const filtered = APP.transactions.filter(t => t.date >= startDate && t.date <= endDate);
                
                const byCategory = {};
                filtered.forEach(t => {
                    if (!byCategory[t.category]) {
                        byCategory[t.category] = { income: 0, expense: 0 };
                    }
                    if (t.type === 'income') {
                        byCategory[t.category].income += parseFloat(t.amount);
                    } else {
                        byCategory[t.category].expense += parseFloat(t.amount);
                    }
                });
                
                doc.setFontSize(16);
                doc.text('Category Analysis', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.text(`Period: ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`, 20, yPos);
                yPos += 15;
                
                doc.setFontSize(11);
                for (const [category, amounts] of Object.entries(byCategory)) {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    const total = amounts.income - amounts.expense;
                    doc.text(`${category}:`, 20, yPos);
                    doc.text(`$${total.toFixed(2)}`, 170, yPos);
                    yPos += 7;
                }
                
            } else if (reportType === 'tax') {
                const year = parseInt(document.getElementById('taxYear').value);
                const yearTransactions = APP.transactions.filter(t => new Date(t.date).getFullYear() === year);
                
                const totalIncome = yearTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                const expensesByCategory = {};
                yearTransactions.filter(t => t.type === 'expense').forEach(t => {
                    if (!expensesByCategory[t.category]) {
                        expensesByCategory[t.category] = 0;
                    }
                    expensesByCategory[t.category] += parseFloat(t.amount);
                });
                
                const totalExpenses = Object.values(expensesByCategory).reduce((sum, val) => sum + val, 0);
                const netProfit = totalIncome - totalExpenses;
                
                doc.setFontSize(16);
                doc.text(`Schedule C - Tax Year ${year}`, 20, yPos);
                yPos += 15;
                
                doc.setFontSize(13);
                doc.text('GROSS INCOME', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                doc.text('Total Income:', 20, yPos);
                doc.text(`$${totalIncome.toFixed(2)}`, 170, yPos);
                yPos += 15;
                
                doc.setFontSize(13);
                doc.text('EXPENSES', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                for (const [category, amount] of Object.entries(expensesByCategory)) {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`${category}:`, 20, yPos);
                    doc.text(`$${amount.toFixed(2)}`, 170, yPos);
                    yPos += 6;
                }
                
                yPos += 5;
                doc.setFontSize(11);
                doc.text('Total Expenses:', 20, yPos);
                doc.text(`$${totalExpenses.toFixed(2)}`, 170, yPos);
                yPos += 15;
                
                doc.setFontSize(14);
                doc.text('NET PROFIT:', 20, yPos);
                doc.text(`$${netProfit.toFixed(2)}`, 170, yPos);
            }
            
            doc.save(`${reportType}-report-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(APP.transactions);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
            XLSX.writeFile(wb, 'transactions.xlsx');
        }

        // Import Functions
        function downloadTemplate() {
            const template = [
                {
                    date: '2025-02-06',
                    type: 'income',
                    category: 'Sales',
                    description: 'Sample income transaction',
                    amount: 1000.00,
                    notes: 'Optional notes field'
                },
                {
                    date: '2025-02-06',
                    type: 'expense',
                    category: 'Office Expense',
                    description: 'Sample expense transaction',
                    amount: 150.00,
                    notes: 'Optional notes field'
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'import-template.xlsx');
        }
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            const fileName = file.name.toLowerCase();
            
            reader.onload = function(e) {
                try {
                    let importedData = [];
                    
                    if (fileName.endsWith('.csv')) {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const values = lines[i].split(',');
                            const transaction = {};
                            
                            headers.forEach((header, index) => {
                                transaction[header] = values[index]?.trim() || '';
                            });
                            
                            importedData.push(transaction);
                        }
                    } else {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        importedData = XLSX.utils.sheet_to_json(firstSheet);
                    }
                    
                    let successCount = 0;
                    let errorCount = 0;
                    
                    importedData.forEach(row => {
                        try {
                            let dateValue = row.date || row.Date || row.DATE || new Date().toISOString().split('T')[0];
                            
                            if (typeof dateValue === 'number') {
                                const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
                                dateValue = excelDate.toISOString().split('T')[0];
                            } else if (dateValue instanceof Date) {
                                dateValue = dateValue.toISOString().split('T')[0];
                            } else if (typeof dateValue === 'string') {
                                if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                                    // Already in correct format
                                } else {
                                    const parsedDate = new Date(dateValue);
                                    if (!isNaN(parsedDate.getTime())) {
                                        dateValue = parsedDate.toISOString().split('T')[0];
                                    }
                                }
                            }
                            
                            const transaction = {
                                date: dateValue,
                                type: (row.type || row.Type || row.TYPE || 'expense').toLowerCase(),
                                category: row.category || row.Category || row.CATEGORY || 'Other Expenses',
                                description: row.description || row.Description || row.DESCRIPTION || 'Imported',
                                amount: parseFloat(row.amount || row.Amount || row.AMOUNT || 0),
                                notes: row.notes || row.Notes || row.NOTES || ''
                            };
                            
                            if (!transaction.date || !transaction.amount || transaction.amount <= 0) {
                                errorCount++;
                                return;
                            }
                            
                            if (!['income', 'expense'].includes(transaction.type)) {
                                transaction.type = 'expense';
                            }
                            
                            const validCategories = [...APP.categories.income, ...APP.categories.expense];
                            if (!validCategories.includes(transaction.category)) {
                                transaction.category = transaction.type === 'income' ? 'Other Income' : 'Other Expenses';
                            }
                            
                            addTransaction(transaction);
                            successCount++;
                        } catch (err) {
                            console.error('Error importing row:', row, err);
                            errorCount++;
                        }
                    });
                    
                    alert(`Import complete!\n\nSuccessfully imported: ${successCount} transactions\nErrors: ${errorCount}`);
                    event.target.value = '';
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing file. Please check the file format.\n\nExpected columns: date, type, category, description, amount, notes');
                    event.target.value = '';
                }
            };
            
            if (fileName.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // Initialize App
        function initializeApp() {
            updateDashboard();
            renderTransactions();
            populateCategoryFilter();
            setDefaultDates();
        }

        function populateCategoryFilter() {
            const select = document.getElementById('filterCategory');
            const allCategories = [...APP.categories.income, ...APP.categories.expense];
            select.innerHTML = '<option value="all">All Categories</option>' +
                allCategories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function setDefaultDates() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = lastDay.toISOString().split('T')[0];
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Check license on load
            if (await checkLicense()) {
                showMainApp();
            }
            
            // License activation
            document.getElementById('activateBtn').addEventListener('click', async () => {
                const key = document.getElementById('licenseKeyInput').value.trim().toUpperCase();
                await activateLicense(key);
            });
            
            document.getElementById('licenseKeyInput').addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    const key = document.getElementById('licenseKeyInput').value.trim().toUpperCase();
                    await activateLicense(key);
                }
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
                });
            });
            
            // Transaction modal
            document.getElementById('addTransactionBtn').addEventListener('click', () => showTransactionModal());
            document.querySelector('.close').addEventListener('click', hideTransactionModal);
            document.querySelector('.cancel-btn').addEventListener('click', hideTransactionModal);
            
            // Transaction form
            document.getElementById('txType').addEventListener('change', (e) => {
                updateCategoryOptions(e.target.value);
            });
            
            document.getElementById('transactionForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const transaction = {
                    date: document.getElementById('txDate').value,
                    type: document.getElementById('txType').value,
                    category: document.getElementById('txCategory').value,
                    description: document.getElementById('txDescription').value,
                    amount: document.getElementById('txAmount').value,
                    notes: document.getElementById('txNotes').value
                };
                
                if (APP.editingTransactionId) {
                    updateTransaction(APP.editingTransactionId, transaction);
                } else {
                    addTransaction(transaction);
                }
                
                hideTransactionModal();
            });
            
            // Filters
            document.getElementById('searchTransaction').addEventListener('input', renderTransactions);
            document.getElementById('filterType').addEventListener('change', renderTransactions);
            document.getElementById('filterCategory').addEventListener('change', renderTransactions);
            
            // Bulk actions
            document.getElementById('selectAllBtn').addEventListener('click', () => {
                document.querySelectorAll('.transaction-checkbox').forEach(cb => cb.checked = true);
            });
            
            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedTransactions);
            
            document.getElementById('exportSelectedBtn').addEventListener('click', () => {
                const selected = Array.from(document.querySelectorAll('.transaction-checkbox:checked'))
                    .map(cb => APP.transactions.find(t => t.id === cb.dataset.id));
                
                if (selected.length === 0) {
                    alert('Please select transactions to export');
                    return;
                }
                
                const ws = XLSX.utils.json_to_sheet(selected);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Selected Transactions');
                XLSX.writeFile(wb, 'selected-transactions.xlsx');
            });
            
            // Import functionality
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            
            document.getElementById('fileInput').addEventListener('change', handleFileImport);
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
            
            // Reports
            document.getElementById('generateReportBtn').addEventListener('click', generateReports);
            
            document.querySelectorAll('.export-pdf').forEach(btn => {
                btn.addEventListener('click', () => {
                    exportToPDF(btn.dataset.report);
                });
            });
            
            // Tax
            document.getElementById('generateTaxBtn').addEventListener('click', generateTaxSummary);
            document.getElementById('exportTaxPdfBtn').addEventListener('click', () => exportToPDF('tax'));
            document.getElementById('exportTaxExcelBtn').addEventListener('click', exportToExcel);
        });
    </script>
</body>
</html>
